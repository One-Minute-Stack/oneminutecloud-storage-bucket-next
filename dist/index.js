var b=async(r,t,e)=>{let{objectId:o,key:i,uploadId:p,partSize:s,parts:a}=t,n=0,d=[];for(let c of a){let l=(c.partNumber-1)*s,m=Math.min(l+s,r.size),g=r.slice(l,m),y=await fetch(c.url,{method:"PUT",body:g});if(!y.ok)throw new Error(`Failed uploading part ${c.partNumber}`);let h=y.headers.get("etag");if(!h)throw new Error(`Missing ETag for part ${c.partNumber}`);d.push({PartNumber:c.partNumber,ETag:h.replace(/"/g,"")}),n+=g.size,e?.onProgress?.({loaded:n,total:r.size,percent:Math.round(n/r.size*100)});}return {objectId:o,key:i,uploadId:p,completedParts:d}};var f=async(r,t)=>{if(r.status===404)throw new Error("[OneMinute Cloud] API route not found. Make sure you have created the file at app/api/oneminutecloud/[provider]/route.ts");let e="Request failed";switch(t){case "initiate":e="Upload initiation failed";break;case "complete":e="Upload completion failed";break;case "preview":e="Failed to get file preview";break}try{let o=await r.json();o.error?e=o.error:o.message&&(e=o.message);}catch{e=r.statusText||e;}throw new Error(`[OneMinute Cloud] ${e}`)};var w=class{static async upload(t,e,o){if(!t)throw new Error("File is required");if(!(t instanceof File))throw new Error("Invalid file");if(!e)throw new Error("Bucket ID is required");if(!/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(e))throw new Error("Invalid bucket ID");let p=await fetch("/api/oneminutecloud/storage-bucket",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"upload",bucketId:e,filename:t.name,contentType:t.type||"application/octet-stream",size:t.size})});p.ok||await f(p,"initiate");let{uploadData:s}=await p.json(),{objectId:a,key:n,uploadId:d,completedParts:c}=await b(t,s,o),l=await fetch("/api/oneminutecloud/storage-bucket",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"complete",bucketId:e,objectId:a,uploadId:d,key:n,parts:c})});return l.ok||await f(p,"complete"),await l.json(),{key:n}}static async get(t){if(!t)throw new Error("File key is required");let e=await fetch("/api/oneminutecloud/storage-bucket",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"preview",key:t})});return e.ok||await f(e,"preview"),await e.json()}},P=w;var u=()=>({baseUrl:"https://api.oneminutecloud.com/api/v1"});var v=async(r,t,e,o,i)=>{let{baseUrl:p}=u(),s=await fetch(`${p}/storage-buckets/${t}/objects/initiate`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":r},body:JSON.stringify({filename:e,contentType:o,size:i})}),a=await s.json();if(!s.ok)throw new Error(a.error||"Failed to initiate upload");return a};var E=async(r,t,e,o,i,p)=>{let{baseUrl:s}=u(),a=await fetch(`${s}/storage-buckets/${t}/objects/${e}/complete`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":r},body:JSON.stringify({uploadId:o,key:i,parts:p})}),n=await a.json();if(!a.ok)throw new Error(n.error||"Failed to complete upload");return n};async function k(r){if(!r||!r.startsWith("OMC_"))return null;let t=r.split("_");if(t.length<3)return null;let e=t[1];return /^[a-f0-9]{32}$/i.test(e)?{success:true}:null}var j=async(r,t)=>{let{baseUrl:e}=u(),o=await fetch(`${e}/storage-buckets/objects/preview`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":r},body:JSON.stringify({key:t})}),i=await o.json();if(!o.ok)throw new Error(i.error||"Failed to generate preview URL");return i};async function U({request:r,props:t,apiKey:e}){try{let o=await t.params,{provider:i}=o;if(!e)throw new Error("ONEMINUTECLOUD_API_KEY is not defined");if(!await k(e))throw new Error("Your API key is invalid!");if(i!=="storage-bucket")return Response.json({error:"Invalid provider"},{status:400});let s=await r.json(),{type:a}=s;if(a==="upload"){let{bucketId:n,filename:d,contentType:c,size:l}=s,m=await v(e,n,d,c,l);return Response.json({uploadData:m})}if(a==="complete"){let{bucketId:n,objectId:d,uploadId:c,key:l,parts:m}=s,g=await E(e,n,d,c,l,m);return Response.json(g)}if(a==="preview"){let{key:n}=s,d=await j(e,n);return Response.json(d)}return Response.json({error:"Invalid action type"},{status:400})}catch(o){return console.error("[OneMinute Cloud] Storage Error:",o),Response.json({error:o.message||"Internal Server Error"},{status:500})}}
export{U as handleStorageRequest,P as storage};