var w=async(r,e,t)=>{let{objectId:s,key:c,uploadId:d,partSize:o,parts:a}=e,n=0,u=[];for(let i of a){let p=(i.partNumber-1)*o,l=Math.min(p+o,r.size),m=r.slice(p,l),y=await fetch(i.url,{method:"PUT",body:m});if(!y.ok)throw new Error(`Failed uploading part ${i.partNumber}`);let h=y.headers.get("etag");if(!h)throw new Error(`Missing ETag for part ${i.partNumber}`);u.push({PartNumber:i.partNumber,ETag:h.replace(/"/g,"")}),n+=m.size,t?.onProgress?.({loaded:n,total:r.size,percent:Math.round(n/r.size*100)});}return {objectId:s,key:c,uploadId:d,completedParts:u}};var f=class{static async upload(e,t,s){if(!e)throw new Error("File is required");if(!(e instanceof File))throw new Error("Invalid file");if(!t)throw new Error("Bucket ID is required");if(!/^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$/i.test(t))throw new Error("Invalid bucket ID");let d=await fetch("/api/oneminutecloud/storage-bucket",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"upload",bucketId:t,filename:e.name,contentType:e.type||"application/octet-stream",size:e.size})});if(!d.ok)throw new Error("[OneMinute Cloud] Missing API route. Make sure you copied the setup code from the docs and added it to app/api/oneminutecloud/[provider]/route.ts. This route is required to handle secure uploads.");let{uploadData:o}=await d.json(),{objectId:a,key:n,uploadId:u,completedParts:i}=await w(e,o,s),p=await fetch("/api/oneminutecloud/storage-bucket",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:"complete",bucketId:t,objectId:a,uploadId:u,key:n,parts:i})});if(!p.ok){let l=await p.json();throw new Error(l.error||"[OneMinute Cloud] Upload completion failed. Make sure the complete handler is present in your API route at app/api/oneminutecloud/[provider]/route.ts.")}return await p.json(),{key:n}}},P=f;var g=()=>({baseUrl:"http://localhost:8080/api"});var b=async(r,e,t,s,c)=>{let{baseUrl:d}=g(),o=await fetch(`${d}/storage-buckets/${e}/objects/initiate`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":r},body:JSON.stringify({filename:t,contentType:s,size:c})}),a=await o.json();if(!o.ok)throw new Error(a.error||"Failed to initiate upload");return a};var E=async(r,e,t,s,c,d)=>{let{baseUrl:o}=g(),a=await fetch(`${o}/storage-buckets/${e}/objects/${t}/complete`,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":r},body:JSON.stringify({uploadId:s,key:c,parts:d})}),n=await a.json();if(!a.ok)throw new Error(n.error||"Failed to complete upload");return n};async function k(r){if(!r||!r.startsWith("OMC_"))return null;let e=r.split("_");if(e.length<3)return null;let t=e[1];return /^[a-f0-9]{32}$/i.test(t)?{success:true}:null}async function j({request:r,props:e,apiKey:t}){try{let s=await e.params,{provider:c}=s;if(!t)throw new Error("ONEMINUTECLOUD_API_KEY is not defined");if(!await k(t))throw new Error("Your API key is invalid!");if(c!=="storage-bucket")return Response.json({error:"Invalid provider"},{status:400});let o=await r.json(),{type:a}=o;if(a==="upload"){let{bucketId:n,filename:u,contentType:i,size:p}=o,l=await b(t,n,u,i,p);return Response.json({uploadData:l})}if(a==="complete"){let{bucketId:n,objectId:u,uploadId:i,key:p,parts:l}=o,m=await E(t,n,u,i,p,l);return Response.json(m)}return Response.json({error:"Invalid action type"},{status:400})}catch(s){return console.error("[OneMinute Cloud] Storage Error:",s),Response.json({error:s.message||"Internal Server Error"},{status:500})}}
export{j as handleStorageRequest,P as storage};